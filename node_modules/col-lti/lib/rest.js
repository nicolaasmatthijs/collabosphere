/**
 * Copyright 2015 UC Berkeley (UCB) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var Collabosphere = require('col-core');
var CollabosphereServer = require('col-core/lib/server');

var LtiAPI = require('./api');
var LtiConstants = require('./constants');

// Don't apply CSRF on the /lti/* endpoints as Canvas uses iframed POSTs to launch a tool
CollabosphereServer.addSafePathPrefix('/lti/');

/**
 * Launch a tool
 *
 * @param  {Request}    req         The incoming request
 * @param  {Response}   res         The ExpressJS response
 * @param  {String}     toolId      The id of the tool that is being launched
 */
var launch = function(req, res, toolId) {
  LtiAPI.launch(req, function(err, body, user) {
    if (err) {
      return res.status(err.code).send(err.msg);
    }

    var api_domain = body.custom_canvas_api_domain;
    var course_id = body.custom_canvas_course_id;

    // We store the user id in cookie specific to the canvas api domain and course. This
    // allows the user to open multiple tools (on multiple Canvas instances) concurrently
    var name = api_domain + '_' + course_id;
    res.cookie(name, user.id, {'signed': true});

    // Redirect the user to the tool's HTML. We need to include the api_domain
    // and course id so the application can bootstrap itself
    var url = '/' + toolId;
    url += '?api_domain=' + body.custom_canvas_api_domain;
    url += '&course_id=' + body.custom_canvas_course_id;
    return res.redirect(url);
  });
};

/*!
 * The launch URL for the Asset Library tool
 */
Collabosphere.ltiRouter.post('/assetlibrary', function(req, res) {
  launch(req, res, LtiConstants.assetLibrary.ID);
});

/*!
 * Describes how the Asset Library tool can be embedded
 */
Collabosphere.ltiRouter.get('/assetlibrary.xml', function(req, res) {
  var xml = LtiAPI.getBasicLTICartridge(req.headers.host, LtiConstants.assetLibrary.ID, LtiConstants.assetLibrary.TITLE, LtiConstants.assetLibrary.DESCRIPTION);

  // Return the XML cartridge
  res.setHeader('Content-Type', 'application/xml');
  return res.status(200).send(xml);
});

/*!
 * The launch URL for the Whiteboards
 */
Collabosphere.ltiRouter.post('/whiteboards', function(req, res) {
  launch(req, res, LtiConstants.whiteboards.ID);
});

/*!
 * Describes how the Whiteboards can be embedded
 */
Collabosphere.ltiRouter.get('/whiteboards.xml', function(req, res) {
  var xml = LtiAPI.getBasicLTICartridge(req.headers.host, LtiConstants.whiteboards.ID, LtiConstants.whiteboards.TITLE, LtiConstants.whiteboards.DESCRIPTION);

  // Return the XML cartridge
  res.setHeader('Content-Type', 'application/xml');
  return res.status(200).send(xml);
});

/*!
 * Describes how the Engagement Index can be embedded
 */
Collabosphere.ltiRouter.get('/engagementindex.xml', function(req, res) {
  var xml = LtiAPI.getBasicLTICartridge(req.headers.host, LtiConstants.engagementIndex.ID, LtiConstants.engagementIndex.TITLE, LtiConstants.engagementIndex.DESCRIPTION);

  // Return the XML cartridge
  res.setHeader('Content-Type', 'application/xml');
  return res.status(200).send(xml);
});

/*!
 * The launch URL for the Engagement Index
 */
Collabosphere.ltiRouter.post('/engagementindex', function(req, res) {
  launch(req, res, LtiConstants.engagementIndex.ID);
});

Collabosphere.appRouter.on('get', '/api/me', function(req, res) {
  res.status(200).send({"canvas_user_id":1103067,"canvas_username":"Nicolaas Matthijs","canvas_roles":["urn:lti:role:ims/lis/TeachingAssistant"]});
});

Collabosphere.appRouter.on('get', '/api/engagementindex', function(req, res) {
  res.status(200).send({"students":[{"id":20557,"name":"Adam Hochman","sortable_name":"Adam, Hochman","points":0,"section":"Unknown","share":false,"percentile":42,"last_activity_date":0},{"id":46029,"name":"Travis Lee","sortable_name":"Lee, Travis","points":0,"section":"Unknown","share":false,"percentile":42,"last_activity_date":0},{"id":46179,"name":"Katrina Fullman","sortable_name":"katrina.fullman@ucop.edu","points":80,"section":"Unknown","share":false,"percentile":44,"last_activity_date":1423789214000},{"id":46602,"name":"Mary-Ellen Kreher","sortable_name":"Mary-Ellen, Kreher","points":0,"section":"Unknown","share":false,"percentile":42,"last_activity_date":0},{"id":55921,"name":"Greg Niemeyer","sortable_name":"Niemeyer, Greg","points":213,"section":"Unknown","share":false,"percentile":50,"last_activity_date":1424807880000},{"id":131533,"name":"Maxwell Delzer","sortable_name":"Delzer, Maxwell","points":351,"section":"Unknown","share":false,"percentile":54,"last_activity_date":1424819240000},{"id":132593,"name":"Claudia Huei-Ying Wong","sortable_name":"Wong, Claudia Huei-Ying","points":364,"section":"Unknown","share":true,"percentile":56,"last_activity_date":1424817492000},{"id":368124,"name":"Scott Friese","sortable_name":"Scott, Friese","points":0,"section":"Unknown","share":false,"percentile":42,"last_activity_date":0},{"id":373892,"name":"Alex Chang","sortable_name":"Chang, Alex","points":694,"section":"Unknown","share":true,"percentile":90,"last_activity_date":1424823649000},{"id":621488,"name":"Michael Wood","sortable_name":"Michael, Wood","points":0,"section":"Unknown","share":false,"percentile":42,"last_activity_date":0},{"id":622626,"name":"Carey Ly","sortable_name":"Ly, Carey","points":516,"section":"Unknown","share":false,"percentile":69,"last_activity_date":1424819233000},{"id":647294,"name":"Dinesh Purohit","sortable_name":"Dinesh, Purohit","points":0,"section":"Unknown","share":false,"percentile":42,"last_activity_date":0},{"id":698940,"name":"Margret Beth Esguerra","sortable_name":"Esguerra, Margret Beth","points":0,"section":"Unknown","share":false,"percentile":42,"last_activity_date":0},{"id":703455,"name":"Raven Mendez","sortable_name":"Mendez, Raven","points":84,"section":"Unknown","share":false,"percentile":46,"last_activity_date":1423166140000},{"id":781243,"name":"Margret Beth Esguerra","sortable_name":"Esguerra, Margret Beth","points":0,"section":"Unknown","share":false,"percentile":42,"last_activity_date":0},{"id":803272,"name":"Julie Khov","sortable_name":"Khov, Julie","points":0,"section":"Unknown","share":false,"percentile":42,"last_activity_date":0},{"id":882859,"name":"Sterling Jefferson Engle","sortable_name":"Sterling Jefferson, Engle","points":1460,"section":"Unknown","share":true,"percentile":99,"last_activity_date":1424831454000},{"id":965477,"name":"Emily Eddy","sortable_name":"Eddy, Emily","points":0,"section":"Unknown","share":false,"percentile":42,"last_activity_date":0},{"id":974058,"name":"Test Student","sortable_name":"Test, Student","points":163,"section":"Unknown","share":true,"percentile":49,"last_activity_date":1424391353000},{"id":993486,"name":"Yucy Yu","sortable_name":"Yu, Yucy","points":0,"section":"Unknown","share":true,"percentile":42,"last_activity_date":0},{"id":1103067,"name":"Nicolaas Matthijs","sortable_name":"Nicolaas, Matthijs","points":0,"section":"Unknown","share":false,"percentile":42,"last_activity_date":1422060667000},{"id":1115996,"name":"Michael Jee","sortable_name":"Jee, Michael","points":952,"section":"Unknown","share":true,"percentile":97,"last_activity_date":1424817508000},{"id":1115997,"name":"Tristan Jones","sortable_name":"Jones, Tristan","points":0,"section":"Unknown","share":false,"percentile":42,"last_activity_date":0},{"id":1115999,"name":"Dhruv Garg","sortable_name":"Garg, Dhruv","points":404,"section":"Unknown","share":true,"percentile":59,"last_activity_date":1424825661000},{"id":1116000,"name":"Arisa Jane Kiyoizumi","sortable_name":"Kiyoizumi, Arisa Jane","points":482,"section":"Unknown","share":true,"percentile":66,"last_activity_date":1424823981000},{"id":1116001,"name":"Marissa Isabella Ramirez Zweiger","sortable_name":"Ramirez Zweiger, Marissa Isabella","points":305,"section":"Unknown","share":false,"percentile":51,"last_activity_date":1424823848000},{"id":1116002,"name":"Jin Young Park","sortable_name":"Park, Jin Young","points":668,"section":"Unknown","share":true,"percentile":85,"last_activity_date":1424817382000},{"id":1116003,"name":"Jonell Madeleine Flock","sortable_name":"Flock, Jonell Madeleine","points":512,"section":"Unknown","share":true,"percentile":68,"last_activity_date":1424819231000},{"id":1116004,"name":"Margaret Segui Sy","sortable_name":"Sy, Margaret Segui","points":550,"section":"Unknown","share":true,"percentile":75,"last_activity_date":1424831454000},{"id":1116005,"name":"Alex Chou","sortable_name":"Chou, Alex","points":545,"section":"Unknown","share":true,"percentile":72,"last_activity_date":1424819263000},{"id":1116006,"name":"Erin Nicole Ford","sortable_name":"Ford, Erin Nicole","points":132,"section":"Unknown","share":false,"percentile":47,"last_activity_date":1424817504000},{"id":1116007,"name":"Patrick Joseph Donohue","sortable_name":"Donohue, Patrick Joseph","points":0,"section":"Unknown","share":false,"percentile":42,"last_activity_date":0},{"id":1116008,"name":"Caleb Kim","sortable_name":"Kim, Caleb","points":526,"section":"Unknown","share":true,"percentile":71,"last_activity_date":1424825508000},{"id":1116009,"name":"Pandu Rendradjaja","sortable_name":"Rendradjaja, Pandu","points":569,"section":"Unknown","share":true,"percentile":77,"last_activity_date":1424824860000},{"id":1116012,"name":"Michelle Seeton Galemmo","sortable_name":"Galemmo, Michelle Seeton","points":704,"section":"Unknown","share":true,"percentile":91,"last_activity_date":1424819255000},{"id":1116014,"name":"Darrell Duane Vermilion","sortable_name":"Vermilion, Darrell Duane","points":0,"section":"Unknown","share":false,"percentile":42,"last_activity_date":0},{"id":1116015,"name":"Elizabeth Bobae Lee","sortable_name":"Lee, Elizabeth Bobae","points":477,"section":"Unknown","share":true,"percentile":63,"last_activity_date":1424819253000},{"id":1116016,"name":"Joseph Gabriel Mahalic","sortable_name":"Mahalic, Joseph Gabriel","points":478,"section":"Unknown","share":true,"percentile":65,"last_activity_date":1424819235000},{"id":1116017,"name":"Kartik Jhingan","sortable_name":"Jhingan, Kartik","points":691,"section":"Unknown","share":true,"percentile":87,"last_activity_date":1424824152000},{"id":1116018,"name":"Harrison Dean Van Andel","sortable_name":"Van Andel, Harrison Dean","points":569,"section":"Unknown","share":true,"percentile":77,"last_activity_date":1424819245000},{"id":1116020,"name":"Lynn Yulin Tsai","sortable_name":"Tsai, Lynn Yulin","points":732,"section":"Unknown","share":false,"percentile":93,"last_activity_date":1424819257000},{"id":1116021,"name":"Patrick Douglas Winnett","sortable_name":"Winnett, Patrick Douglas","points":635,"section":"Unknown","share":true,"percentile":81,"last_activity_date":1424819249000},{"id":1116022,"name":"Bryce Kapono Smith-Hudgens","sortable_name":"Smith-Hudgens, Bryce Kapono","points":612,"section":"Unknown","share":false,"percentile":79,"last_activity_date":1424819244000},{"id":1116023,"name":"Andrew Cary Balcof","sortable_name":"Balcof, Andrew Cary","points":401,"section":"Unknown","share":false,"percentile":57,"last_activity_date":1424816619000},{"id":1116024,"name":"Julie Sullivan-Bergman","sortable_name":"Sullivan-Bergman, Julie","points":0,"section":"Unknown","share":false,"percentile":42,"last_activity_date":0},{"id":1116025,"name":"Laszlo Bolender","sortable_name":"Bolender, Laszlo","points":549,"section":"Unknown","share":true,"percentile":74,"last_activity_date":1424819259000},{"id":1116026,"name":"Dominga Asuncion Opazo","sortable_name":"Opazo, Dominga Asuncion","points":462,"section":"Unknown","share":true,"percentile":62,"last_activity_date":1424825170000},{"id":1116027,"name":"Crystal Zongyu Yan","sortable_name":"Crystal Zongyu, Yan","points":759,"section":"Unknown","share":false,"percentile":96,"last_activity_date":1424825800000},{"id":1116028,"name":"Patrick Michael Laird","sortable_name":"Laird, Patrick Michael","points":650,"section":"Unknown","share":true,"percentile":84,"last_activity_date":1424826149000},{"id":1137144,"name":"Tiffany Sala","sortable_name":"Sala, Tiffany","points":0,"section":"Unknown","share":false,"percentile":42,"last_activity_date":0},{"id":1145024,"name":"Weiwen Jiang","sortable_name":"Jiang, Weiwen","points":733,"section":"Unknown","share":true,"percentile":94,"last_activity_date":1424826215000},{"id":1174692,"name":"Alexiz Andrea Gomez","sortable_name":"Gomez, Alexiz Andrea","points":61,"section":"Unknown","share":true,"percentile":43,"last_activity_date":1424314190000},{"id":1193297,"name":"Sofia Cicelia Gutierrez-Dewar","sortable_name":"Gutierrez-Dewar, Sofia Cicelia","points":0,"section":"Unknown","share":false,"percentile":42,"last_activity_date":0},{"id":1193298,"name":"Shirui Ouyang","sortable_name":"Ouyang, Shirui","points":637,"section":"Unknown","share":true,"percentile":82,"last_activity_date":1424831198000},{"id":1193299,"name":"Ziao Liu","sortable_name":"Liu, Ziao","points":692,"section":"Unknown","share":false,"percentile":88,"last_activity_date":1424823315000},{"id":1193300,"name":"Carlos Alfredo Saravia","sortable_name":"Saravia, Carlos Alfredo","points":426,"section":"Unknown","share":true,"percentile":60,"last_activity_date":1424815546000},{"id":1193301,"name":"Carmen Lucia Gutierrez Ballon Val","sortable_name":"Gutierrez Ballon Val, Carmen Lucia","points":0,"section":"Unknown","share":true,"percentile":42,"last_activity_date":0},{"id":1193302,"name":"Lily Lin","sortable_name":"Lin, Lily","points":0,"section":"Unknown","share":false,"percentile":42,"last_activity_date":0},{"id":1193303,"name":"Molly Anne O'Neil","sortable_name":"O'Neil, Molly Anne","points":0,"section":"Unknown","share":false,"percentile":42,"last_activity_date":0},{"id":1193304,"name":"Henok Ambelu","sortable_name":"Ambelu, Henok","points":0,"section":"Unknown","share":false,"percentile":42,"last_activity_date":0},{"id":1194891,"name":"Diying Xiong","sortable_name":"Xiong, Diying","points":0,"section":"Unknown","share":true,"percentile":42,"last_activity_date":0},{"id":1198825,"name":"An Hoang Ngo","sortable_name":"Ngo, An Hoang","points":0,"section":"Unknown","share":false,"percentile":42,"last_activity_date":0},{"id":1198826,"name":"Jonathan Jing Qi Wang","sortable_name":"Wang, Jonathan Jing Qi","points":0,"section":"Unknown","share":false,"percentile":42,"last_activity_date":0},{"id":1200260,"name":"Mya Katherine Kotalac","sortable_name":"Kotalac, Mya Katherine","points":351,"section":"Unknown","share":true,"percentile":54,"last_activity_date":1424824448000},{"id":1200261,"name":"Hayley Marie Covarrubias","sortable_name":"Covarrubias, Hayley Marie","points":0,"section":"Unknown","share":false,"percentile":42,"last_activity_date":0},{"id":1204682,"name":"Margret Beth Esguerra","sortable_name":"Esguerra, Margret Beth","points":0,"section":"Unknown","share":false,"percentile":42,"last_activity_date":0},{"id":1204683,"name":"Julie Khov","sortable_name":"Khov, Julie","points":0,"section":"Unknown","share":false,"percentile":42,"last_activity_date":0},{"id":1204684,"name":"Yucy Yu","sortable_name":"Yu, Yucy","points":0,"section":"Unknown","share":false,"percentile":42,"last_activity_date":0}],"current_canvas_user":{"id":23,"canvas_user_id":1103067,"name":"Nicolaas Matthijs","sortable_name":"Nicolaas, Matthijs","sis_user_id":-1,"primary_email":"nicolaas@berkeley.edu","section":"Unknown","share":false,"created_at":"2015-01-16T18:01:24.809Z","updated_at":"2015-02-25T02:33:56.897Z","has_answered_share_question":true},"current_canvas_user_points":0});
});

var createAsset = function(id, type, thumbnail_url, title, canvas_user_id, canvas_displayname, likes, dislikes, views, comments) {
  return {
    id: id,
    type: type,
    thumbnail_url: thumbnail_url,
    title: title,
    canvas_user: {
      canvas_user_id: canvas_user_id,
      canvas_displayname: canvas_displayname
    },
    likes: likes,
    dislikes: dislikes,
    views: views,
    comments: comments
  }
};

Collabosphere.appRouter.on('get', '/api/assetlibrary', function(req, res) {
  var page1 = [
    createAsset(1, 'image', 'http://www.1zoom.net/big2/794/254213-svetik.jpg?m=1', 'Lake USA Tahoe', 1, 'Nicolaas Matthijs', 10, 1, 35, 6),
    createAsset(2, 'image', 'http://www.1zoom.me/big2/510/315957-svetik.jpg?m=1', 'Gardens Pond Earl Burns Miller Japanese', 2, 'Sam Peck', 10, 1, 35, 6),
    createAsset(3, 'image', 'http://www.1zoom.me/big2/797/285355-svetik.jpg?m=1', 'Mountains Bishop', 3, 'Simon Gaeremynck', 10, 1, 35, 6),
    createAsset(4, 'image', 'http://s1.1zoom.me/big0/602/410759-svetik.jpg', 'Forests Roads Trees Nature', 1, 'Branden Visser', 10, 1, 35, 6),
    createAsset(5, 'image', 'http://s1.1zoom.me/big0/628/410761-svetik.jpg', 'Sea Coast Sunrises and sunsets Sky Stones Sun Nature', 1, 'Anne-Sophie De Baets', 10, 1, 35, 6),
    createAsset(6, 'image', 'http://s1.1zoom.me/big0/706/410758-svetik.jpg', 'Switzerland Scenery Mountains Bernese Oberland Fir Grass Nature', 1, 'Oliver Heyer', 10, 1, 35, 6),
    createAsset(7, 'image', 'http://s1.1zoom.me/big0/219/410757-svetik.jpg', 'Waterfalls Moss Nature', 1, 'Christian Vuerings', 10, 1, 35, 6),
    createAsset(8, 'image', 'http://s1.1zoom.me/big0/15/410754-svetik.jpg', 'Germany Parks Nehren Trees Grass Nature', 1, 'John Crossman', 10, 1, 35, 6)
  ];

  res.status(200).send(page1);
});
