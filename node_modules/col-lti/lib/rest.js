/**
 * Copyright 2015 UC Berkeley (UCB) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var Collabosphere = require('col-core');
var CollabosphereServer = require('col-core/lib/server');

var LtiAPI = require('./api');
var LtiConstants = require('./constants');

// Don't apply CSRF on the /lti/* endpoints as Canvas uses iframed POSTs to launch a tool
CollabosphereServer.addSafePathPrefix('/lti/');

/**
 * Launch a tool
 *
 * @param  {Request}    req         The incoming request
 * @param  {Response}   res         The ExpressJS response
 * @param  {String}     toolId      The id of the tool that is being launched
 */
var launch = function(req, res, toolId) {
  LtiAPI.launch(req, function(err, body, user) {
    if (err) {
      return res.status(err.code).send(err.msg);
    }

    var api_domain = body.custom_canvas_api_domain;
    var course_id = body.custom_canvas_course_id;

    // We store the user id in cookie specific to the canvas api domain and course. This
    // allows the user to open multiple tools (on multiple Canvas instances) concurrently
    var name = api_domain + '_' + course_id;
    res.cookie(name, user.id, {'signed': true});

    // Redirect the user to the tool's HTML. We need to include the api_domain
    // and course id so the application can bootstrap itself
    var url = '/' + toolId;
    url += '?api_domain=' + encodeURIComponent(body.custom_canvas_api_domain);
    url += '&course_id=' + encodeURIComponent(body.custom_canvas_course_id);
    url += '&tool_url=' + encodeURIComponent(body.tool_url);
    return res.redirect(url);
  });
};

/*!
 * The launch URL for the Asset Library tool
 */
Collabosphere.ltiRouter.post('/assetlibrary', function(req, res) {
  launch(req, res, LtiConstants.ASSETLIBRARY.id);
});

/*!
 * Describes how the Asset Library tool can be embedded
 */
Collabosphere.ltiRouter.get('/assetlibrary.xml', function(req, res) {
  var xml = LtiAPI.getBasicLTICartridge(req.headers.host, LtiConstants.ASSETLIBRARY.id, LtiConstants.ASSETLIBRARY.title, LtiConstants.ASSETLIBRARY.description);

  // Return the XML cartridge
  res.setHeader('Content-Type', 'application/xml');
  return res.status(200).send(xml);
});

/*!
 * The launch URL for the Whiteboards
 */
Collabosphere.ltiRouter.post('/whiteboards', function(req, res) {
  launch(req, res, LtiConstants.WHITEBOARDS.id);
});

/*!
 * Describes how the Whiteboards can be embedded
 */
Collabosphere.ltiRouter.get('/whiteboards.xml', function(req, res) {
  var xml = LtiAPI.getBasicLTICartridge(req.headers.host, LtiConstants.WHITEBOARDS.id, LtiConstants.WHITEBOARDS.title, LtiConstants.WHITEBOARDS.description);

  // Return the XML cartridge
  res.setHeader('Content-Type', 'application/xml');
  return res.status(200).send(xml);
});

/*!
 * Describes how the Engagement Index can be embedded
 */
Collabosphere.ltiRouter.get('/engagementindex.xml', function(req, res) {
  var xml = LtiAPI.getBasicLTICartridge(req.headers.host, LtiConstants.ENGAGEMENTINDEX.id, LtiConstants.ENGAGEMENTINDEX.title, LtiConstants.ENGAGEMENTINDEX.description);

  // Return the XML cartridge
  res.setHeader('Content-Type', 'application/xml');
  return res.status(200).send(xml);
});

/*!
 * The launch URL for the Engagement Index
 */
Collabosphere.ltiRouter.post('/engagementindex', function(req, res) {
  launch(req, res, LtiConstants.ENGAGEMENTINDEX.id);
});
